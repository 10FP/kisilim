{% extends "base.html" %}

{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <p class="eyebrow">Ders Seçimi</p>
            <h2>Ders al / bırak ve zorluk tahminlerini gör</h2>
            <p class="muted">Tahmini zorluk, geçmiş sınıf ortalamaları ve değerlendirme ağırlıklarına dayanır.</p>
        </div>
        <form method="get" class="inline-form">
            <label>
                Öğrenci
                <select name="student">
                    {% for s in students %}
                        <option value="{{ s.id }}" {% if student and s.id == student.id %}selected{% endif %}>{{ s.full_name }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">Seç</button>
        </form>
    </header>

    {% if not student %}
        <p class="muted">Öğrenci bulunamadı.</p>
    {% else %}
    <div class="cards">
        <article class="card">
            <h4>Alınan dersler</h4>
            <table class="compact">
                <thead>
                    <tr>
                        <th>Ders</th>
                        <th>Dönem</th>
                        <th>Final Puan</th>
                        <th>Durum</th>
                        <th>Aksiyon</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in enrolled %}
                    {% with e=item.enrollment %}
                    <tr>
                        <td>{{ e.course.code }} - {{ e.course.name }}</td>
                        <td>{{ e.course.term }}</td>
                        <td>{{ item.final }}</td>
                        <td>
                            <span class="tag {% if e.result == 'passed' %}easy{% elif e.result == 'failed' %}hard{% else %}secondary{% endif %}">
                                {% if e.result == 'passed' %}Geçti{% elif e.result == 'failed' %}Kaldı{% else %}Devam{% endif %}
                            </span>
                            <div class="inline-form">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="set_result">
                                    <input type="hidden" name="course" value="{{ e.course.id }}">
                                    <input type="hidden" name="result" value="passed">
                                    <button type="submit" class="btn primary">Geçti</button>
                                </form>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="set_result">
                                    <input type="hidden" name="course" value="{{ e.course.id }}">
                                    <input type="hidden" name="result" value="failed">
                                    <button type="submit" class="btn danger">Kaldı</button>
                                </form>
                            </div>
                        </td>
                        <td>
                            <form method="post" class="inline-form">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="drop">
                                <input type="hidden" name="course" value="{{ e.course.id }}">
                                <button type="submit" class="btn danger">Bırak</button>
                            </form>
                        </td>
                    </tr>
                    {% endwith %}
                {% empty %}
                    <tr><td colspan="5" class="muted">Henüz ders alınmadı.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </article>

        <article class="card">
            <h4>Alınabilecek dersler (tahmini zorluk)</h4>
            <div class="course-grid">
                {% for item in available %}
                    {% with course=item.course diff=item.diff %}
                    <div class="course-chip">
                        <div class="chip-head">
                            <div>
                                <strong>{{ course.code }}</strong>
                                <div class="muted small">{{ course.name }}</div>
                            </div>
                            <span class="tag {% if diff.label == 'Kolay' %}easy{% elif diff.label == 'Orta' %}medium{% else %}hard{% endif %}">{{ diff.label }}</span>
                        </div>
                        <p class="muted small">
                            {% if diff.personal %}Geçmiş skorun: {{ diff.avg_score }}
                            {% else %}Sınıf ort.: {{ diff.avg_score }}{% endif %} |
                            Max bileşen ağırlığı: %{{ diff.max_weight }}
                        </p>
                        <p class="muted small">LO benzerlik kapsaması: %{{ item.coverage }}</p>
                        <p class="muted small">
                            {% if item.known_los %}
                                Bildiğin LO'lar: {{ item.known_los|join:", " }} (geçtiğin derslerden)
                            {% else %}
                                Bu dersteki LO'lar senin için yeni.
                            {% endif %}
                        </p>
                        <ul class="plain small">
                            {% for r in diff.reasons %}
                                <li>• {{ r }}</li>
                            {% endfor %}
                        </ul>
                        <form method="post" class="inline-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add">
                            <input type="hidden" name="course" value="{{ course.id }}">
                            <button type="submit" class="btn primary">Dersi Ekle</button>
                        </form>
                    </div>
                    {% endwith %}
                {% empty %}
                    <p class="muted">Tüm dersler alınmış görünüyor.</p>
                {% endfor %}
            </div>
        </article>
    </div>
    {% endif %}
</section>
{% endblock %}
