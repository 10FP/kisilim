{% extends "base.html" %}

{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <p class="eyebrow">Öğrenci Paneli</p>
            <h2>Ders seç ve ilerlemeyi izle</h2>
            <p class="muted">Seçilen dersin not bileşenleri, LO–PO bağlantıları ve program çıktı performansı.</p>
        </div>
        <form method="get" class="inline-form">
            <label>
                Öğrenci
                <select name="student">
                    {% for s in students %}
                        <option value="{{ s.id }}" {% if student and s.id == student.id %}selected{% endif %}>{{ s.full_name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Ders
                <select name="course">
                    {% for c in courses %}
                        <option value="{{ c.id }}" {% if selected_course and c.id == selected_course.id %}selected{% endif %}>{{ c.code }} - {{ c.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">Göster</button>
        </form>
    </header>

    {% if enrollments %}
        {% for enrollment in enrollments %}
        <div class="course-card">
            <header>
                <div>
                    <p class="eyebrow">{{ enrollment.course.term }}</p>
                    <h3>{{ enrollment.course.code }} – {{ enrollment.course.name }}</h3>
                </div>
                <span class="tag secondary">Öğrenci görünümü</span>
            </header>

            <div class="grid">
                <div>
                    <h4>Not bileşenleri</h4>
                    <table class="compact">
                        <thead>
                            <tr>
                                <th>Bileşen</th>
                                <th>Yüzde</th>
                                <th>Not</th>
                                <th>Sınıf Ort.</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for item in enrollment.assessments %}
                            <tr>
                                <td>{{ item.name }}</td>
                                <td>{{ item.weight }}%</td>
                                <td>{% if item.score %}{{ item.score }}{% else %}-{% endif %}</td>
                                <td>{% if item.class_avg %}{{ item.class_avg }}{% else %}-{% endif %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div>
                    <h4>ÖÇ katkıları</h4>
                    <table class="compact">
                        <thead>
                            <tr>
                                <th>LO</th>
                                <th>PÇ</th>
                                <th>Skor</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for lo in enrollment.learning_outcomes %}
                            <tr>
                                <td>{{ lo.obj.code }}</td>
                                <td>
                                    {% for mapping in lo.mappings %}
                                        <span class="pill small">{{ mapping.program_outcome.code }} ({{ mapping.weight }})</span>
                                    {% empty %}
                                        <span class="muted">Bağlantı yok</span>
                                    {% endfor %}
                                </td>
                                <td>{{ lo.score }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <section class="panel" id="program-performance">
            <header class="panel-header">
                <div>
                    <p class="eyebrow">Program Çıktısına Göre Performans</p>
                    <h2>Çıktı bazlı ilerleme</h2>
                </div>
            </header>
            <div class="bar-list">
                {% for item in po_performance %}
                    <div class="bar-row">
                        <div class="bar-label">
                            <strong>{{ item.program_outcome.code }}</strong>
                            <span class="muted">{{ item.program_outcome.title }}</span>
                        </div>
                        <div class="bar">
                            <span style="width: {{ item.score }}%"></span>
                        </div>
                        <div class="bar-value">{{ item.score }}</div>
                    </div>
                {% empty %}
                    <p class="muted">Performans verisi yok.</p>
                {% endfor %}
            </div>
        </section>
    {% else %}
        <p class="muted">Seçilen ders için kayıtlı öğrenci veya not verisi yok.</p>
    {% endif %}
</section>
{% endblock %}
